<head>
  <style type="text/css">
      svg{ overflow:visible !important; } /*easier than trying to size the SVG element right*/
  </style>
</head>
<body>
  <div id="graph"></div>
  <script type="text/javascript" src="http://underscorejs.org/underscore-min.js"></script>
  <script type="text/javascript" src="https://rawgithub.com/anvaka/VivaGraphJS/master/dist/vivagraph.min.js"></script>
  <script type="text/coffeescript">
    window.ObjectGraph = (rootId, nodes, nodeLinks)->
      graph = Viva.Graph.graph()

      _.each nodes, (node, node_id)->
        graph.addNode node_id, node

      _.each nodeLinks, (nodeLinkList, key)->
        _.each nodeLinkList, (nodeLink)->
          graph.addLink(key, nodeLink)

      graphics = Viva.Graph.View.svgGraphics()
      graphics.node (node)-> #build the node element from SVG and HTML components
        fillColor = if node.data.id == rootId then 'red' else 'blue'
        svg = Viva.Graph.svg('svg')
        g = svg.appendChild Viva.Graph.svg('g')
        g.appendChild Viva.Graph.svg('rect').attr('width', 10).attr('height', 10).attr('fill', fillColor)

        #foreign element sizeing could be done a lot better than what I have here
        foreignOject = g.appendChild Viva.Graph.svg('foreignObject').attr('width', '10em').attr('height', '1em').attr('fill', fillColor)
        body = foreignOject.appendChild document.createElementNS('http://www.w3.org/1999/xhtml', 'body')
        div = body.appendChild document.createElement('div')
        div.appendChild(document.createElement 'span' ).textContent = node.data.name
        svg

      layout = Viva.Graph.Layout.forceDirected graph,
        springLength : 10
        springCoeff  : 0.00005
        dragCoeff    : 0.02
        gravity      : -10

      renderer = Viva.Graph.View.renderer graph, 
        graphics  : graphics 
        layout    : layout 
        container : document.getElementById('graph')

      renderer.run()
  </script>
  <script type="text/javascript" src="http://jashkenas.github.io/coffee-script/extras/coffee-script.js"></script>

  <script type="text/javascript">
    setTimeout( function() {
        json = {"rootId":"t1","edges":{"t1":["n0"],"n0":["n1"],"n1":["n2","n4","n5"],"n2":["n3a"],"n3a":["n3b","n3e"],"n3b":["n3d"],"n3d":["n3f"],"n3f":["n3g"],"n3g":["g01","n3h","n3e"],"g01":[],"n3h":[],"n3e":["p01","g02","n3i"],"p01":[],"g02":["g03"],"g03":["g02"],"n3i":["p01","p02","p03","g03"],"p02":[],"p03":[],"n4":[],"n5":[]},"nodes":{"t1":{"id":"t1","name":"The Title Screen"},"n0":{"id":"n0","name":"The Beginning"},"n1":{"id":"n1","name":"Keep learning"},"n2":{"id":"n2","name":"Face detection in ruby"},"n3a":{"id":"n3a","name":"A simple program to detect faces"},"n3b":{"id":"n3b","name":"Have OpenCV do the composition"},"n3d":{"id":"n3d","name":"Learning How to learn OpenCV in Ruby"},"n3f":{"id":"n3f","name":"What documentation is available?"},"n3g":{"id":"n3g","name":"Grep the source like a boss"},"g01":{"id":"g01","name":"What's 'arity'?"},"n3h":{"id":"n3h","name":"Writing Ruby-c extensions"},"n3e":{"id":"n3e","name":"I can haz live image?"},"p01":{"id":"p01","name":"Process.spawn"},"g02":{"id":"g02","name":"Working with Bytes"},"g03":{"id":"g03","name":"Access the Bytes in Ruby"},"n3i":{"id":"n3i","name":"I can haz movie?"},"p02":{"id":"p02","name":"| Pipelining |"},"p03":{"id":"p03","name":"Streams of Text"},"n4":{"id":"n4","name":"Hardware hacking"},"n5":{"id":"n5","name":"Ruby, without the rails"}}}
        ObjectGraph(json.rootId, json.nodes, json.edges);
      }, 1000 );
  </script>
</body>
